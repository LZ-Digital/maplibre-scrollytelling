<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scrollytelling – Heatmap Deutschland</title>
  <link href="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: system-ui, -apple-system, sans-serif; 
      overflow-x: hidden;
      background-color: #f0f0f0;
    }

    .scroll-container {
      position: relative;
      width: 100%;
    }

    #map {
      position: sticky;
      top: 0;
      width: 100%;
      height: 100vh; /* Nutzt die volle Höhe des Iframes */
      z-index: 0;
    }

    .steps {
      position: relative;
      z-index: 1;
      max-width: 420px;
      margin: 0 auto;
      /* Padding unten ist kritisch, damit der letzte Step über die Mitte scrollen kann */
      padding: 0 1rem 100vh 1rem;
    }

    .step {
      margin-bottom: 90vh; /* Großer Abstand für sauberes Scrollytelling */
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-radius: 12px;
      transition: opacity 0.3s ease;
      opacity: 0.3;
    }

    .step.is-active { 
      opacity: 1;
      box-shadow: 0 12px 35px rgba(0,0,0,0.25);
    }

    .step h2 { margin: 0 0 0.75rem; font-size: 1.4rem; color: #111; }
    .step p { margin: 0; font-size: 1rem; line-height: 1.6; color: #333; }
  </style>
</head>
<body>
  <div class="scroll-container">
    <div id="map"></div>
    <div class="steps">
      <div class="step" data-scene="overview">
        <h2>Überblick</h2>
        <p>Die Heatmap zeigt beispielhafte Standortdaten in Deutschland. Dichte und Intensität werden farblich dargestellt.</p>
      </div>
      <div class="step" data-scene="munich">
        <h2>München</h2>
        <p>Hohe Konzentration im Zentrum: Marienplatz, Maxvorstadt und Schwabing.</p>
      </div>
      <div class="step" data-scene="berlin">
        <h2>Berlin</h2>
        <p>Schwerpunkt Mitte: Brandenburger Tor, Alexanderplatz und Kreuzberg.</p>
      </div>
      <div class="step" data-scene="rhein-ruhr">
        <h2>Rhein-Ruhr</h2>
        <p>Düsseldorf, Köln und Essen – Ballungsraum mit mehreren Hotspots.</p>
      </div>
      <div class="step" data-scene="hamburg">
        <h2>Hamburg</h2>
        <p>Zentrum um Rathaus, HafenCity und St. Pauli.</p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollama/3.2.0/scrollama.min.js"></script>
  <script>
    (function () {
      var map;
      var scenes = {
        overview: { center: [10.5, 51.2], zoom: 5.5 },
        munich:   { center: [11.576, 48.137], zoom: 11.5 },
        berlin:   { center: [13.405, 52.52], zoom: 11.5 },
        'rhein-ruhr': { center: [6.95, 51.15], zoom: 9.0 },
        hamburg:  { center: [9.99, 53.55], zoom: 11.5 }
      };

      // Map Initialisierung
      map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/bright',
        center: scenes.overview.center,
        zoom: scenes.overview.zoom,
        scrollZoom: false,
        attributionControl: false
      });

      map.on('load', function () {
        // Beispiel-Quelle hinzufügen (Heatmap)
        map.addSource('heatmap-points', {
          type: 'geojson',
          data: 'https://maplibre.org/maplibre-gl-js/docs/assets/earthquakes.geojson' // Beispiel-URL
        });

        map.addLayer({
          id: 'heatmap',
          type: 'heatmap',
          source: 'heatmap-points',
          paint: {
            'heatmap-weight': 1,
            'heatmap-intensity': 1,
            'heatmap-color': [
              'interpolate', ['linear'], ['heatmap-density'],
              0, 'rgba(0,0,255,0)', 0.2, 'royalblue', 0.4, 'cyan', 
              0.6, 'lime', 0.8, 'yellow', 1, 'red'
            ],
            'heatmap-radius': 15,
            'heatmap-opacity': 0.7
          }
        });

        initScrollama();
      });

      function initScrollama() {
        var scroller = scrollama();

        scroller
          .setup({
            step: '.step',
            offset: 0.5, // Trigger in der Bildschirmmitte
            debug: false
          })
          .onStepEnter(function (response) {
            var el = response.element;
            var sceneId = el.getAttribute('data-scene');
            
            document.querySelectorAll('.step').forEach(s => s.classList.remove('is-active'));
            el.classList.add('is-active');

            if (sceneId && scenes[sceneId]) {
              map.flyTo({
                ...scenes[sceneId],
                duration: 2000,
                essential: true
              });
            }
          });

        window.addEventListener('resize', scroller.resize);
      }

      // Kommunikation mit dem Parent-Fenster
      if (window !== window.top) {
        // Empfange Scroll-Events vom Parent
        window.addEventListener('message', function (e) {
          if (e.data.type === 'scroll' && typeof e.data.deltaY === 'number') {
            window.scrollBy(0, e.data.deltaY);
            sendScrollState();
          }
        });

        // Melde Scroll-Zustand an Parent
        function sendScrollState() {
          var y = window.pageYOffset || document.documentElement.scrollTop;
          var h = window.innerHeight;
          var docH = document.documentElement.scrollHeight;

          window.parent.postMessage({
            type: 'scrollState',
            atTop: y <= 5,
            atBottom: (y + h) >= (docH - 5)
          }, '*');
        }

        window.addEventListener('scroll', sendScrollState, { passive: true });
        window.addEventListener('load', sendScrollState);
      }
    })();
  </script>
</body>
</html>