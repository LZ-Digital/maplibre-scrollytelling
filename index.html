<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Heatmap Scrollytelling – Standorte Deutschland</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }

    #scroll-container {
      overflow-y: auto;
      overflow-x: hidden;
      height: 100%;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    #graphic {
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      min-height: 400px;
      z-index: 0;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #e8e8e8;
    }

    #steps {
      position: relative;
      z-index: 1;
      pointer-events: none;
      margin-top: -100vh;
    }

    .step {
      min-height: 100vh;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
    }

    .step-content {
      background: rgba(255, 255, 255, 0.96);
      padding: 1rem 1.25rem;
      border-radius: 8px;
      max-width: 420px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
    }

    .step-content h2 { margin: 0 0 0.25em; font-size: 1.25rem; }
    .step-content p { margin: 0; font-size: 0.9375rem; line-height: 1.45; color: #333; }

    .step-last { padding-bottom: env(safe-area-inset-bottom, 1rem); }

    @media (max-width: 768px) {
      #steps { margin-top: -85vh; }
      .step { min-height: 85vh; padding: 0.75rem 1rem; }
      .step-content { padding: 0.875rem 1rem; }
      .step-content h2 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <div id="scroll-container">
    <div id="graphic">
      <div id="map"></div>
    </div>
    <div id="steps">
      <div class="step" data-step="overview" data-lng="10.45" data-lat="51.17" data-zoom="5">
        <div class="step-content">
          <h2>Standorte in Deutschland</h2>
          <p>Scrollen Sie, um in die Ballungsräume zu zoomen. Die Heatmap zeigt die Dichte der Standorte.</p>
        </div>
      </div>
      <div class="step" data-step="muenchen" data-lng="11.576" data-lat="48.137" data-zoom="12">
        <div class="step-content">
          <h2>München</h2>
          <p>Starker Fokus auf Zentrum, Marienplatz und Maxvorstadt.</p>
        </div>
      </div>
      <div class="step" data-step="berlin" data-lng="13.405" data-lat="52.52" data-zoom="12">
        <div class="step-content">
          <h2>Berlin</h2>
          <p>Mitte, Alexanderplatz und Kreuzberg mit hoher Intensität.</p>
        </div>
      </div>
      <div class="step" data-step="hamburg" data-lng="9.994" data-lat="53.551" data-zoom="12">
        <div class="step-content">
          <h2>Hamburg</h2>
          <p>Rathaus, St. Pauli und HafenCity im Fokus.</p>
        </div>
      </div>
      <div class="step" data-step="frankfurt" data-lng="8.682" data-lat="50.111" data-zoom="12">
        <div class="step-content">
          <h2>Frankfurt</h2>
          <p>Zentrum und Hauptwache mit hoher Dichte.</p>
        </div>
      </div>
      <div class="step" data-step="koeln" data-lng="6.953" data-lat="50.941" data-zoom="12">
        <div class="step-content">
          <h2>Köln</h2>
          <p>Dom und Altstadt als Schwerpunkte.</p>
        </div>
      </div>
      <div class="step step-last" data-step="outro" data-lng="10.45" data-lat="51.17" data-zoom="5">
        <div class="step-content">
          <h2>Überblick</h2>
          <p>Alle Standorte im Überblick. Ende der Demo.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/scrollama@3.2.0/build/scrollama.min.js"></script>
  <script>
    (function () {
      var inIframe = window.self !== window.top;
      var scrollContainer = document.getElementById('scroll-container');
      var mapEl = document.getElementById('map');

      var map = new maplibregl.Map({
        container: mapEl,
        style: 'https://tiles.openfreemap.org/styles/positron',
        center: [10.45, 51.17],
        zoom: 5,
        attributionControl: true
      });

      map.scrollZoom.disable();

      map.on('load', function () {
        fetch('data/heatmap-data.geojson')
          .then(function (r) { return r.json(); })
          .then(function (geojson) {
            map.addSource('heatmap-points', { type: 'geojson', data: geojson });
            map.addLayer({
              id: 'heatmap',
              type: 'heatmap',
              source: 'heatmap-points',
              paint: {
                'heatmap-weight': ['/', ['get', 'intensity'], 10],
                'heatmap-intensity': 1,
                'heatmap-radius': 20,
                'heatmap-opacity': 0.7
              }
            });
          })
          .catch(function () {
            console.warn('Heatmap-Daten konnten nicht geladen werden.');
          });
      });

      var scroller = scrollama();
      scroller
        .setup({
          step: '.step',
          offset: 0.5,
          progress: false,
          container: scrollContainer
        })
        .onStepEnter(function (response) {
          var el = response.element;
          var lng = parseFloat(el.getAttribute('data-lng'), 10);
          var lat = parseFloat(el.getAttribute('data-lat'), 10);
          var zoom = parseFloat(el.getAttribute('data-zoom'), 10);
          if (!isNaN(lng) && !isNaN(lat) && !isNaN(zoom)) {
            map.flyTo({ center: [lng, lat], zoom: zoom, duration: 1200, essential: true });
          }
        });

      map.on('resize', function () { map.resize(); });
      window.addEventListener('resize', function () { map.resize(); });

      if (inIframe) {
        window.addEventListener('message', function (e) {
          if (!e.data || e.data.type !== 'scroll') return;
          var dy = e.data.deltaY;
          if (typeof dy !== 'number') return;
          scrollContainer.scrollTop += dy;
        });

        function sendScrollState() {
          var st = scrollContainer.scrollTop;
          var sh = scrollContainer.scrollHeight;
          var ch = scrollContainer.clientHeight;
          try {
            window.parent.postMessage({
              type: 'scrollState',
              atTop: st <= 2,
              atBottom: st + ch >= sh - 2
            }, '*');
          } catch (err) {}
        }

        scrollContainer.addEventListener('scroll', sendScrollState, { passive: true });
        sendScrollState();
      }
    })();
  </script>
</body>
</html>
